// Unified Prisma Schema for FastMine
// Combines features from all environment-specific schemas
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                 String            @id @default(cuid())
  telegramId                         String            @unique
  username                           String?
  firstName                          String?
  lastName                           String?
  avatarUrl                          String?
  role                               UserRole          @default(USER)
  createdAt                          DateTime          @default(now())
  updatedAt                          DateTime          @updatedAt
  lastSeenAt                         DateTime?
  referralCode                       String            @unique
  referredById                       String?
  totalInvested                      Float             @default(0)
  lastDepositAt                      DateTime?
  lastWithdrawalAt                   DateTime?
  lastSlotPurchaseAt                 DateTime?
  captchaValidated                   Boolean           @default(false)
  lastReferralZeroPenaltyAppliedAt   DateTime?
  isSuspicious                       Boolean           @default(false)
  lastSuspiciousPenaltyAppliedAt     DateTime?
  rank                               String?
  lastInvestmentGrowthBonusClaimedAt DateTime?
  isOnline                           Boolean           @default(false)
  permissions                        String[]          @default([])
  managedBy                          String?
  
  // Admin system fields
  lastActivityAt                     DateTime?
  isActive                           Boolean           @default(true)
  isFrozen                           Boolean           @default(false)
  frozenAt                           DateTime?
  frozenReason                       String?
  activityScore                      Float             @default(0)
  totalEarnings                      Float             @default(0)
  totalWithdrawn                     Float             @default(0)
  firstWithdrawalAt                  DateTime?
  hasMadeDeposit                     Boolean           @default(false)
  lastLotteryTicketAt                DateTime?
  
  // Relations
  activityLogs                       ActivityLog[]
  completedTasks                     CompletedTask[]
  lotteryTickets                     LotteryTicket[]
  miningSlots                        MiningSlot[]
  swapTransactions                   SwapTransaction[]
  referredBy                         User?             @relation("UserReferrals", fields: [referredById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referrals                          User[]            @relation("UserReferrals")
  wallets                            Wallet[]
  notifications                      Notification[]
  referralEarnings                   ReferralEarning[]
  withdrawals                        Withdrawal[]
  investments                        Investment[]
  accountFreezes                     AccountFreeze[]
  deposits                           Deposit[]
  achievements                       UserAchievement[]
  bonuses                            Bonus[]

  @@index([referredById])
  @@index([telegramId])
  @@index([createdAt])
  @@index([lastSeenAt])
  @@index([role])
  @@index([isSuspicious])
  @@index([totalInvested])
  @@index([isOnline])
  @@index([managedBy])
  @@index([isActive])
  @@index([isFrozen])
  @@index([activityScore])
  @@index([lastActivityAt])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String
  currency  String   @default("USD")
  balance   Float    @default(0)
  frozen    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, currency])
  @@index([userId])
  @@index([currency])
}

model MiningSlot {
  id                  String   @id @default(cuid())
  userId              String
  principal           Float
  accruedEarnings     Float    @default(0)
  startAt             DateTime @default(now())
  lastAccruedAt       DateTime
  effectiveWeeklyRate Float
  expiresAt           DateTime
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  type                String   @default("standard")
  isLocked            Boolean  @default(false)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([type])
  @@index([userId, isActive])
  @@index([isLocked])
}

model Task {
  id          String          @id @default(cuid())
  taskId      String          @unique
  title       String
  description String
  reward      Float
  link        String
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  completedBy CompletedTask[]

  @@index([isActive])
}

model CompletedTask {
  userId    String
  taskId    String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, taskId])
}

model ActivityLog {
  id           String          @id @default(cuid())
  userId       String
  type         ActivityLogType
  amount       Float?
  description  String
  sourceUserId String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime        @default(now())
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, type])
  @@index([userId, createdAt])
}

model Lottery {
  id             String          @id @default(cuid())
  drawDate       DateTime
  jackpot        Float
  isDrawn        Boolean         @default(false)
  winningNumbers String?
  createdAt      DateTime        @default(now())
  tickets        LotteryTicket[]

  @@index([drawDate])
  @@index([isDrawn])
}

model LotteryTicket {
  id              String   @id @default(cuid())
  userId          String
  lotteryId       String?
  numbers         String?
  ticketNumber    Int?
  isWinner        Boolean  @default(false)
  prizeAmount     Float?
  isAdminSelected Boolean  @default(false)
  createdAt       DateTime @default(now())
  lottery         Lottery? @relation(fields: [lotteryId], references: [id], onDelete: SetNull)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lotteryId])
  @@index([isWinner])
}

model ExchangeRate {
  id        String   @id @default(cuid())
  rate      Float
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
}

model SwapTransaction {
  id           String   @id @default(cuid())
  userId       String
  USDAmount    Float
  MNEAmount   Float
  exchangeRate Float
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model Notification {
  id            String   @id @default(cuid())
  userId        String
  type          String
  title         String
  message       String
  isRead        Boolean  @default(false)
  priority      String  @default("normal")
  status        String  @default("PENDING")
  scheduledFor  DateTime?
  attempts      Int     @default(0)
  lastAttemptAt DateTime?
  error         String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([status])
  @@index([priority])
}

model Investment {
  id                  String   @id @default(cuid())
  userId              String
  amount              Float
  type                InvestmentType
  status              InvestmentStatus @default(ACTIVE)
  startDate           DateTime @default(now())
  endDate             DateTime
  expectedReturn      Float
  actualReturn        Float @default(0)
  weeklyRate          Float
  isLocked            Boolean @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@index([isLocked])
}

model Withdrawal {
  id              String   @id @default(cuid())
  userId          String
  amount          Float
  currency        String   @default("USD")
  status          WithdrawalStatus @default(PENDING)
  type            WithdrawalType
  adminApproved   Boolean @default(false)
  adminId         String?
  processedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ReferralEarning {
  id              String   @id @default(cuid())
  userId          String
  sourceUserId    String
  amount          Float
  type            ReferralEarningType
  level           Int
  isCapped        Boolean @default(false)
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sourceUserId])
  @@index([type])
}

model DailyPayout {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalAmount     Float
  totalUsers      Int
  processedUsers  Int @default(0)
  status          PayoutStatus @default(PENDING)
  processedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  details         DailyPayoutDetail[]
  
  @@index([date])
  @@index([status])
}

model DailyPayoutDetail {
  id              String   @id @default(cuid())
  payoutId        String
  userId          String
  amount          Float
  investmentId    String?
  processed       Boolean @default(false)
  processedAt     DateTime?
  createdAt       DateTime @default(now())
  
  payout          DailyPayout @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  
  @@index([payoutId])
  @@index([userId])
}

model AccountFreeze {
  id              String   @id @default(cuid())
  userId          String
  reason          FreezeReason
  duration        Int?
  frozenAt        DateTime @default(now())
  unfrozenAt      DateTime?
  adminId         String
  description     String?
  isActive        Boolean @default(true)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isActive])
  @@index([frozenAt])
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String
  amount    Float
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

model Bonus {
  id          String   @id @default(cuid())
  userId      String
  amount      Float
  type        String
  description String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

// Enums
enum UserRole {
  USER
  ADMIN
  MANAGER
  STAFF
  SUPPORT
}

enum InvestmentType {
  WELCOME_BONUS
  STANDARD
  PREMIUM
  REFERRAL_BONUS
}

enum InvestmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  FROZEN
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PROCESSED
  REJECTED
  CANCELLED
}

enum WithdrawalType {
  FIRST_WITHDRAWAL
  REGULAR_WITHDRAWAL
  EMERGENCY_WITHDRAWAL
}

enum ReferralEarningType {
  SIGNUP_BONUS
  DEPOSIT_COMMISSION
  EARNINGS_COMMISSION
  ACTIVITY_BONUS
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum FreezeReason {
  INACTIVITY
  SUSPICIOUS_ACTIVITY
  VIOLATION_TERMS
  ADMIN_DECISION
  SYSTEM_DETECTED
}

enum ActivityLogType {
  DEPOSIT
  WITHDRAWAL
  CLAIM
  NEW_SLOT_PURCHASE
  SLOT_EXTENSION
  REFERRAL_SIGNUP_BONUS
  REFERRAL_COMMISSION
  REFERRAL_DEPOSIT_BONUS
  TASK_REWARD
  DAILY_BONUS
  WELCOME_BONUS
  REINVESTMENT
  LEADERBOARD_BONUS
  INVESTMENT_GROWTH_BONUS
  DIVIDEND_BONUS
  REFERRAL_3_IN_3_DAYS_BONUS
  BALANCE_ZEROED_PENALTY
  BALANCE_FROZEN_PENALTY
  LOTTERY_TICKET_PURCHASE
  LOTTERY_WIN
  SWAP_USD_TO_MNE
  EXCHANGE_RATE_CHANGE
  ADMIN_LOTTERY_WIN
  LOGIN
  LOGOUT
  INVESTMENT_CREATED
  INVESTMENT_COMPLETED
  WITHDRAWAL_REQUESTED
  WITHDRAWAL_APPROVED
  WITHDRAWAL_REJECTED
  REFERRAL_EARNED
  ACCOUNT_FROZEN
  ACCOUNT_UNFROZEN
  PASSWORD_CHANGED
  PROFILE_UPDATED
  ADMIN_ACTION
  EARNINGS
  REFERRAL
  BONUS
  TASK_COMPLETION
  ACHIEVEMENT_UNLOCK
  INVESTMENT_GROWTH
  DIVIDENDS_BONUS
}